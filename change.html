<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SINoALICE„Éä„Ç§„Éà„É°„Ç¢„Ç≥„É≥„Éù„Éº„Çµ„Éº </title>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"/>
    <style>
        .icon{
            height: 75px;
            width: 75px;
        }
        .list-icon{
            height: 100px;
            width: 100px;
            display:flex;
        }
        .popover {
            max-width:300px;
        }
        .list-item{
            position: relative;
            transition: all 0.1s;
            max-width:100px;
        }
        .close-classic{
            color: #777;
            font: 25px/100% arial, sans-serif;
            right: 5px;
            text-decoration: none;
            text-shadow: 0 1px 0 #fff;
            top: 5px;
            background-color: black;
            position: absolute;
            float: left;
            margin-left: 80px;
        }
    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <h3 class="navbar-brand">SINoALICE„Éä„Ç§„Éà„É°„Ç¢„Ç≥„É≥„Éù„Éº„Çµ„Éº</h3>
    </nav>
</header>


<main role="main" id="app" class="container-fluid mh-100 mt-2 mb-1 pl-1 pr-t">
    <div class="row align-items-start">
        <div class="col-sm-4">
            <div class="card">
                <h5 class="card-header">„Éä„Ç§„Éà„É°„Ç¢‰∏ÄË¶ß</h5>
                <div class="card-body" style="max-height: 90vh; xoverflow-y: scroll;" id="popover-target">
                    <div class="row mb-3">
                        <b-input-group>
                            <b-form-input v-model="searchTerm" placeholder="ÂêçÂâç„Åß„Éï„Ç£„É´„Çø„Éº"></b-form-input>
                            <b-input-group-append>
                                <b-btn @click="searchTerm=''">üóô</b-btn>
                            </b-input-group-append>
                        </b-input-group>
                    </div>
                    <div class="row" style="max-height:70vh; overflow: auto;">
                        <div v-for="nm in filteredNm" class="col mb-2">
                            <img class ="icon float-left"
                                 v-b-popover.hover="showNightmare(nm.name)"
                                 container="popover-target"
                                 variant="success"
                                 :src="'https://placehold.jp/126x126.png?text=' + nm.name"
                                 :title="nm.name"
                                 @click="addNightmare($event, nm.name)">


                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-sm-2">
            <div class="card">
                <h5 class="card-header">„É°„Ç¢È†Ü</h5>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm"></div>
                        <div class="col-sm">
                            <draggable :list="order" class="dragArea" @update="plotChart()">
                                <transition-group name="list">
                                    <div v-for="o in order" class="list-item" v-bind:key="o.name">
                                        <img class="list-icon" :src="'https://placehold.jp/126x126.png?text=' + o.name">
                                        <a href="#" @click="removeNightmare($event, o.name)" class="close-classic">‚úñ</a>
                                    </div>
                                </transition-group>
                            </draggable>
                        </div>
                        <div class="col-sm"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="card">
                <h5 class="card-header">„Ç§„É≥„Éï„Ç©</h5>
                <div class="card-body ">
                    <b-tabs>
                        <b-tab title="ÊôÇÈñìË°®">
                            <b-table :items="timetable">

                            </b-table>
                        </b-tab>
                        <b-tab title="„Çø„Ç§„É†„É©„Ç§„É≥">
                            <div id="chart" class="w-100">

                            </div>
                        </b-tab>
                        <b-tab title="„Çª„Éº„ÉñÔºè„Ç∑„Çß„Ç¢">
                            <div class="row mb-3">
                                <b-input-group>
                                    <b-form-input readonly v-model="URL" id="url-input"></b-form-input>
                                    <b-input-group-append>
                                        <b-btn @click="copyURL('url-input')">üìã„Ç≥„Éî„Éº</b-btn>
                                    </b-input-group-append>
                                </b-input-group>

                                <b-input-group>
                                    <b-input-group-append>
                                        <b-btn @click="shortenURL()">„É™„É≥„ÇØ„ÇíÁü≠„Åè!</b-btn>
                                    </b-input-group-append>
                                    <b-form-input readonly v-model="shortURL" id="short-url-input"></b-form-input>
                                    <b-input-group-append>
                                        <b-btn @click="copyURL('short-url-input')">üìã„Ç≥„Éî„Éº</b-btn>
                                    </b-input-group-append>
                                </b-input-group>

                            </div>
                        </b-tab>
                    </b-tabs>

                </div>
            </div>
        </div>
    </div>

</main>

<script src="https://unpkg.com/vue"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script src="https://unpkg.com/vue-directive-tooltip@latest/dist/vueDirectiveTooltip.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.7.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.16.0/vuedraggable.min.js"></script>
<script src="https://unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
<script>
    var rawData = '[{"name":"„Éù„Éî„Éº","rarity":"6","duration":"120","desc":"","skillName":"","cast":"80"},{"name":"„Ç¶„Ç¨„É´","rarity":"6","duration":"120","desc":"","skillName":"","cast":"80"},{"name":"„Éï„É™„Ç¥","rarity":"6","duration":"120","desc":"","skillName":"","cast":"80"},{"name":"„É™„É≥„Éà","rarity":"6","duration":"120","desc":"","skillName":"","cast":"80"},{"name":"„Éé„Ç§„É≥","rarity":"6","duration":"100","desc":"","skillName":"","cast":"50"},{"name":"„Éü„Éà„É©","rarity":"6","duration":"0","desc":"","skillName":"","cast":"50"},{"name":"„Éê„Éº„Éê„É™„Ç¢„É≥","rarity":"6","duration":"120","desc":"","skillName":"","cast":"60"},{"name":"„Éï„Ç°„É©","rarity":"6","duration":"100","desc":"","skillName":"","cast":"50"},{"name":"„É©„Ç§„Éñ„É©","rarity":"6","duration":"0","desc":"","skillName":"","cast":"50"},{"name":"„Éñ„É©„É≥","rarity":"6","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„É§„Çø„Ç¨„É©„Çπ","rarity":"6","duration":"0","desc":"","skillName":"","cast":"50"},{"name":"„Çπ„Ç´„É¨","rarity":"6","duration":"80","desc":"","skillName":"","cast":"40"},{"name":"„Ç™„Éá„Ç£","rarity":"6","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„Éá„Ç£„Ç¢„Éú","rarity":"6","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„Éâ„É™„É•","rarity":"6","duration":"100","desc":"","skillName":"","cast":"50"},{"name":"„Ç≥„Ç≥","rarity":"6","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„Ç¶„É≠„Éú","rarity":"6","duration":"0","desc":"","skillName":"","cast":"70"},{"name":"„Éï„Ç£„Ç¢","rarity":"6","duration":"0","desc":"","skillName":"","cast":"40"},{"name":"ÈéßÂ∑®‰∫∫","rarity":"6","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„É¶„Éé","rarity":"6","duration":"100","desc":"","skillName":"","cast":"50"},{"name":"„É™„Ç≥„Éç","rarity":"6","duration":"100","desc":"","skillName":"","cast":"50"},{"name":"„Ç∑„É´„Çø„Ç§","rarity":"6","duration":"0","desc":"","skillName":"","cast":"50"},{"name":"„É≠„Ç§„Çµ","rarity":"5","duration":"0","desc":"","skillName":"","cast":"60"},{"name":"„Ç¶„Ç£„Ç¥","rarity":"5","duration":"0","desc":"","skillName":"","cast":"40"},{"name":"„Ç¨„É™„Ç¢","rarity":"5","duration":"0","desc":"","skillName":"","cast":"20"},{"name":"„Éñ„Éñ","rarity":"5","duration":"0","desc":"","skillName":"","cast":"10"},{"name":"„Éó„É≠„É°","rarity":"5","duration":"0","desc":"","skillName":"","cast":"20"},{"name":"„É™„ÉÜ„Ç£","rarity":"5","duration":"100","desc":"","skillName":"","cast":"60"},{"name":"„Éä„ÉÑ„Éé","rarity":"5","duration":"100","desc":"","skillName":"","cast":"60"}]';
</script>
<script>
    var nmData = JSON.parse(rawData);
    var url = new URL(window.location.href);
    var orderJson = JSON.parse(decodeURI(url.searchParams.get("order")));
    var order = []
    for(o in orderJson){
        for(nm in nmData) {
            if (nmData[nm].name === orderJson[o]) {
                if (!order.includes(nmData[nm])) {
                    order.push(nmData[nm])
                }
            }
        }
    }
    var app = new Vue({
        el:'#app',
        components: {
        },
        data: {
            nightmares: nmData,
            order: order,
            searchTerm: "",
            shortURL: ""
        },
        computed:{
            filteredNm : function(){
                var haystack = this.sortedByRarity;
                if(this.searchTerm === "") return haystack;
                return haystack.filter(needle => needle.name.includes(this.searchTerm));
            },
            sortedByRarity : function(){
                function sortByRarity(a,b){
                    if(parseInt(a.rarity) < parseInt(b.rarity))
                        return -1;
                    if(parseInt(a.rarity) > parseInt(b.rarity))
                        return 1;
                    return 0;
                }
                return this.nightmares.sort(sortByRarity).reverse();
            },
            timetable: function(){
                function pt(s){
                    return Math.max((s/60>>0),0) + ":" + ((s%60 >= 10)? s%60 : "0"+ Math.max(s%60, 0));
                }
                var timeNow = 20 * 60;
                var entries = [];
                var nm = this.order;
                for(n in nm){
                    var t = parseInt(nm[n].cast) + parseInt(nm[n].duration)
                    entries.push({Ë©†Âî±ÈñãÂßã: pt(timeNow), „É°„Ç¢ÁµÇ‰∫Ü: pt(timeNow - t), „É°„Ç¢: nm[n].name })
                    timeNow -= t;
                }
                return entries;
            },
            URL: function () {
                var l = this.order;
                var t = []
                for (var i in l){
                    t.push(l[i].name);
                }
                return [location.protocol, '//', location.host, location.pathname].join('') + "?order=" + encodeURI(JSON.stringify(t))
            }
        },
        methods: {
            addNightmare: function(e, name) {
                for(nm in this.nightmares){
                    if(this.nightmares[nm].name === name){
                        if(!this.order.includes(this.nightmares[nm])) {
                            this.order.push(this.nightmares[nm])
                            this.plotChart();
                        }
                    }
                }
            },
            removeNightmare: function (e, name) {
                for(nm in this.order){
                    if(this.order[nm].name === name){
                        this.order.splice(nm, 1)
                    }
                }
                this.plotChart();
            },
            showNightmare: function(name){
                var needle;
                for(nm in nmData){
                    if(nmData[nm].name === name){
                        needle = nmData[nm]
                    }
                }
                var o = {
                    title: '<h4>' + needle.name + '</h4>',
                    content: "<div class=\"container\">\n" +
                    "                            <div class=\"row\"><h5>" + needle.skillName + "</h5></div>" +
                    "                            <div class=\"row mt-1\"> Ë©†Âî±ÊúüÈñìÔºö" + needle.cast + "Áßí</div>" +
                    "                            <div class=\"row mb-1\"> ÂäπÊûúÊúüÈñìÔºö" + needle.duration + "Áßí</div>" +
                    "                            <div class=\"row\">" + needle.desc + "</div>" +
                    "                        </div>",
                    html: true,
                    delay: {show:200, hide:200},
                    placement: "rightbottom"
                }
                return o;
            } ,
            shortenURL: function(){
                this.shortURL = "„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ";
                var that = this;
                var url = this.URL;
                console.log(JSON.stringify({longUrl : url}));
                var key = "AIzaSyAaOjqINWxlWjgFHjxBuaZQW0Vs6aUN80c"; //I know what you're thinking but no.
                var xhr = new XMLHttpRequest();
                xhr.open("POST", 'https://www.googleapis.com/urlshortener/v1/url?key=' + key, true);
                xhr.setRequestHeader("Content-type", "application/json");
                xhr.send(JSON.stringify({longUrl : url}));
                xhr.onreadystatechange = function(){
                    if(xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200){
                        that.shortURL = JSON.parse(xhr.responseText).id;
                    }else{
                        that.shortURL = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
                    }
                }
            },
            copyURL: function(id){
                document.getElementById(id).select();
                document.execCommand("Copy");
            },
            plotChart: function(){
                var timeline = []
                var nm = this.order
                for(n in nm){
                    timeline.push({label: nm[n].name + "Ë©†Âî±", y: parseInt(nm[n].cast)})
                    if(!(parseInt(nm[n].duration) === 0)){
                        timeline.push({label: nm[n].name + "Áô∫Âãï", y: parseInt(nm[n].duration)})
                    }
                }
                var chart = new CanvasJS.Chart("chart", {
                    theme: "light1",
                    animationEnabled: true,
                    title: {
                        text: "ÊôÇÈñìÂâ≤"
                    },
                    axisY: {
                        title: "",
                        prefix: "Áßí",
                        lineThickness: 0,
                        suffix: "",
                        reversed: true
                    },
                    data: [{
                        type: "waterfall",
                        indexLabel: "{y}",
                        dataPoints: timeline
                    }]
                });
                chart.render();
            }
        },
    });
    app.plotChart();
</script>

</body>
</html>
